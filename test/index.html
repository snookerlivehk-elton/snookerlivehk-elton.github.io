<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Snooker Multi-Device Room Test</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 24px; }
      input, button, textarea { padding: 8px; font-size: 14px; }
      .row { margin-bottom: 12px; }
      #log { border: 1px solid #ccc; padding: 12px; height: 220px; overflow: auto; background: #fafafa; }
      code { background: #f5f5f5; padding: 2px 4px; }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2 style="margin:0;">Snooker Multi-Device Room Test</h2>
      <a href="/admin.html" style="font-size:14px;">Admin 概覽</a>
    </div>
    <p>
      同源測試頁（目錄版）：部署在 `snookerhk.live` 下可直接連到後端 Socket。<br />
      可用查詢參數覆蓋：<code>socketUrl</code>、<code>socketPath</code>。
      例：<code>?socketUrl=https://snookerhk.live&socketPath=/socket.io</code>
    </p>

    <div class="row">
      <label>Room ID: <input id="roomId" placeholder="e.g. demo-1" /></label>
      <button id="joinBtn">Join Room</button>
      <button id="leaveBtn">Leave Room</button>
    </div>

    <div class="row">
      <label>Game State JSON:</label><br />
      <textarea id="state" rows="5" cols="80">{"scoreA":0,"scoreB":0}</textarea><br />
      <button id="broadcastBtn">Broadcast State</button>
    </div>

    <div class="row">
      <strong>Socket:</strong> <code id="socketInfo"></code>
    </div>

    <div id="log"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const socketUrl = params.get('socketUrl') || window.location.origin;
      const socketPath = params.get('socketPath') || '/socket.io';

      const socket = io(socketUrl, { path: socketPath, transports: ['websocket','polling'] });
      const logEl = document.getElementById('log');
      const sockEl = document.getElementById('socketInfo');
      const roomInput = document.getElementById('roomId');
      const stateInput = document.getElementById('state');

      function log(msg) {
        const time = new Date().toISOString();
        logEl.innerHTML += '[' + time + '] ' + msg + '<br />';
        logEl.scrollTop = logEl.scrollHeight;
      }

      socket.on('connect', () => {
        sockEl.textContent = 'connected (' + socket.id + ') → ' + socketUrl + ' ' + socketPath;
        log('connected: ' + socket.id);
      });
      socket.on('disconnect', (reason) => { log('disconnected: ' + reason); });
      socket.on('connect_error', (err) => { log('connect_error: ' + (err && err.message || String(err))); });
      socket.on('error', (err) => { log('error: ' + (err && err.message || String(err))); });
      socket.on('gameState updated', (st) => { log('received state: ' + JSON.stringify(st)); });

      document.getElementById('joinBtn').onclick = () => {
        const room = roomInput.value.trim();
        if (!room) return alert('Room ID required');
        socket.emit('join room', room);
        log('joined room: ' + room);
      };
      document.getElementById('leaveBtn').onclick = () => {
        const room = roomInput.value.trim();
        if (!room) return alert('Room ID required');
        socket.emit('leave room', room);
        log('left room: ' + room);
      };
      document.getElementById('broadcastBtn').onclick = () => {
        const room = roomInput.value.trim();
        if (!room) return alert('Room ID required');
        let parsed;
        try { parsed = JSON.parse(stateInput.value); } catch { return alert('Invalid JSON'); }
        socket.emit('update gameState', { roomId: room, newState: parsed });
        log('broadcast state: ' + JSON.stringify(parsed));
      };
    </script>
  </body>
  </html>